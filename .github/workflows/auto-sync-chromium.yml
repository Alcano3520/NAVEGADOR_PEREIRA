name: Auto Sync Chromium

# Este workflow sincroniza autom치ticamente con Chromium upstream
# para mantener el navegador actualizado con los 칰ltimos parches de seguridad

on:
  schedule:
    # Ejecutar todos los lunes a las 3 AM UTC (cr칤tico para seguridad)
    - cron: '0 3 * * 1'
  workflow_dispatch: # Permitir ejecuci칩n manual

env:
  DEPOT_TOOLS_UPDATE: 0

jobs:
  sync-and-audit:
    name: Sync Chromium and Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout Navegador Pereira
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "${{ github.workspace }}/depot_tools" >> $GITHUB_PATH

      - name: Cache Chromium Source
        uses: actions/cache@v3
        with:
          path: chromium
          key: chromium-src-${{ github.run_id }}
          restore-keys: |
            chromium-src-

      - name: Sync Chromium
        id: sync
        run: |
          chmod +x scripts/sync-chromium.sh
          ./scripts/sync-chromium.sh 2>&1 | tee sync.log

          # Capturar estad칤sticas
          if grep -q "Nueva versi칩n disponible" sync.log; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Security Audit
        id: audit
        if: steps.sync.outputs.has_updates == 'true'
        run: |
          chmod +x scripts/security-audit.sh
          ./scripts/security-audit.sh 7 > audit-report.txt

          # Detectar parches cr칤ticos
          SECURITY_COUNT=$(grep -c "Security\|CVE" audit-report.txt || echo 0)
          echo "security_count=$SECURITY_COUNT" >> $GITHUB_OUTPUT

          cat audit-report.txt

      - name: Create Issue for Security Updates
        if: steps.sync.outputs.has_updates == 'true' && steps.audit.outputs.security_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const auditReport = require('fs').readFileSync('audit-report.txt', 'utf8');
            const securityCount = '${{ steps.audit.outputs.security_count }}';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `游뚿 ${securityCount} parches de seguridad disponibles`,
              body: `## Actualizaci칩n de Seguridad Detectada

Se han detectado **${securityCount} commits de seguridad** en Chromium upstream.

### Reporte de Auditor칤a:
\`\`\`
${auditReport}
\`\`\`

### Acci칩n Requerida:
1. Revisar los cambios
2. Recompilar el navegador
3. Distribuir actualizaci칩n a usuarios

### Comandos:
\`\`\`bash
./scripts/sync-chromium.sh
./scripts/build.sh
./scripts/package.sh
\`\`\`

---
*Auto-generado por workflow de sincronizaci칩n autom치tica*`,
              labels: ['security', 'auto-sync', 'high-priority']
            });

            console.log(`Issue creado: ${issue.data.html_url}`);

      - name: Upload Audit Report
        if: steps.sync.outputs.has_updates == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: |
            audit-report.txt
            sync.log
          retention-days: 30

      - name: Send Notification
        if: steps.audit.outputs.security_count > 0
        run: |
          echo "::warning::游뚿 ${{ steps.audit.outputs.security_count }} parches de seguridad detectados. Se ha creado un issue."
